---
title: 'Stat 579 - Homework #5 - Section A'
date: "10/3/2019"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Another look at the Behavioral Risk Factor Surveillance System 

We are, again, using the data from the Behavioral Risk Factor Surveillance System (BRFSS). Just as a reminder, the BRFSS surveys six individual-level behavioral health risk factors associated with the leading causes of premature mortality and morbidity among adults: 1) cigarette smoking, 2) alcohol use, 3) physical activity, 4) diet, 5) hypertension, and 6) safety belt use. 

A subset of the data concentrating on Iowa with records for 2018 is given at
```{r, message = FALSE, warning = FALSE}
url <- "https://raw.githubusercontent.com/Stat579-at-ISU/stat579-at-isu.github.io/master/homework/data/brfss-iowa-2018.csv"
```

The following code reads the data into your R session:
```{r, cache = TRUE, warning = FALSE}
iowa <- read.csv(url)
```

```{r}
library(kableExtra)
library(tidyverse)
library(ggmosaic)
```


A codebook describing the survey and a listing of all variables is available at https://www.cdc.gov/brfss/annual_data/2017/pdf/codebook17_llcp-v2-508.pdf.

For each of the questions, show the code necessary to retrieve the answer. 
Make sure to also write the answer to the question in a sentence.


1. Download the RMarkdown file with these homework instructions to use as a template for your work.
Make sure to replace "Your Name" in the YAML with your name.
2. Load the dataset into your session and store it in the object `iowa`.

3. Check the codebook for an explanation of the variable `DRNK3GE5`. Do a frequency breakdown of the variable `DRNK3GE5` (visually or numerically). Comment.

Introduce a variable `bingedays` into the `iowa` data set that encodes 88 as 0, and 77 and 99 as `NA`. <br>
<!--Hint: a combination of `mutate` and `ifelse` might be helpful. <br>-->
Find the following summaries.

First note that the variable  `DRNK3GE5` records the answer to the following question:

'Considering all types of alcoholic beverages, how many times during the past 30 days did you have 5 or more drinks for men or 4 or more drinks for women on an occasion?'

The following table and plot present a frequency breakdown for each variable. 

```{r}
##Table
Tally_D<-iowa %>%
  group_by(DRNK3GE5) %>%
  tally()

kable(Tally_D)

##Bar plot for counts
ggplot(iowa,aes(x=as.factor(DRNK3GE5)))+geom_bar()






```

To recode the variable, the codebook states that if the answer is between 1:76 then that is the number of times, 88 none or 0 and the rest could be considered as missing values or NA. 

```{r}
iowa<-iowa %>%
  mutate(bingedays=ifelse(DRNK3GE5 %in% 1:76,DRNK3GE5,
                      ifelse(DRNK3GE5==88,0,NA)))
```


a. What is the average number of times respondents admitted to binge drinking in the past 30 days?
b. On how many reports is this average based (exclude missing values)?

To answer these two questions, I used the summarize command, the first statistic computed is the simple mean omitting the NA, and the second column computes the number of cases that are not NA, hence used to compute the mean.

```{r}
iowa %>%
  summarize(Mean=round(mean(bingedays,na.rm = T),2),N_valid=sum(!is.na(bingedays)))
```

 
c. Is there a difference in this average between the genders? Is that difference significant? 

To do this, the first step is to inspect the data by gender using statistics like the mean and the SD. On average, males (Sex1=1) binge drink more times than females (Sex1=2) and there seems to be more dispersion in males than in females, ie unequal variance. 

```{r}
iowa %>%
  filter(SEX1==1|SEX1==2)%>%
  group_by(SEX1)%>%
  summarize(Mean=round(mean(bingedays,na.rm = T),2),
            SD=round(sd(bingedays,na.rm = T),2),
            Min=min(bingedays,na.rm = T),
            Max=max(bingedays,na.rm = T))
```

A visual inspection could be also used to see this difference.

```{r}
iowa %>%
  filter(SEX1==1|SEX1==2)%>%
  ggplot(aes(y=bingedays,fill=as.factor(SEX1)))+
  geom_boxplot()

iowa %>%
  filter(SEX1==1|SEX1==2)%>%
  ggplot(aes(x=bingedays,fill=as.factor(SEX1)))+
  geom_histogram(binwidth =1,position = "identity",alpha=.3)

```


To assess whether the difference is significant I employ a t-test assuming different variance by population (as seen in the previous part). In this case, the p-value is less than 5% so there is enough evidence to reject the null in favor of the alternative, meaning that the difference is significant between females and males. Note that the Welch test assumes normality, so it may not be the most appropriate test to use in this case. Other options like non-parametric test or Poisson Models could be used but were not explored.

```{r}
t.test(iowa %>%
  filter(SEX1==1 & !is.na(bingedays)) %>% select(bingedays),
  iowa %>%
  filter(SEX1==2 & !is.na(bingedays)) %>% select(bingedays),paired = FALSE)

```


4. Current smoking status is imputed in the variable `X_SMOKER3` (corresponds to variable `_SMOKER3` in the codebook). Make `X_SMOKER3` a factor.  Relabel levels 1, 2, 3, 4 to `Current Smoker`, `Current Smoker`, `Former Smoker` and `Never Smoked` (yes, `Current Smoker` is repeated on purpose) and level 9 to NA.
Describe the relationship between smoking status and age (use `X_AGE_G` - read up on `_AGE_G` in the codebook) based on an appropriate visualization. 

Note that the new category `X_SMOKER3_re` will have three levels, Current, Former or never a smoker. `X_AGE_G` is a factor variable that group age into 6 categories (18-24,25-34,45-54,55-64,>65), 

The following code recode the smoker variable into the three group and plot a bar plot using the fill option. In this case, we can conclude that the percentage of non-smoker decrease as we move into an older age group, which could be related to exposure time. The age group 25-34 has the largest percentage of current smokers. It may be argued that as you age, the chance of having smoked increase (exposure effect) and so does the chance to quit smoking.  


```{r}
iowa<-iowa %>%
mutate(X_SMOKER3_re=ifelse(X_SMOKER3==1 |X_SMOKER3==2,"Current Smoker",
                    ifelse(X_SMOKER3==3,"Former Smoker",
                    ifelse(X_SMOKER3==4,"Never Smoked",NA))))

iowa$X_AGE_G_label <-factor(iowa$X_AGE_G,
labels = c("18-24","25-34","35-44","45-54","55-64",">65"))

iowa$SEX1_label <-factor(iowa$SEX1,
labels = c("Male", "Female", "NR","unknown") )

ggplot(iowa, aes(x = X_AGE_G_label,fill=X_SMOKER3_re)) + 
  geom_bar(position = "fill" )+
  scale_fill_brewer(palette='Pastel2')+ scale_fill_discrete(name = 'Smoker type')+xlab("Age group")+ylab("Percent by age group")
```




5. What percentage of the population has never smoked? Calculate this percentage by age groups (`X_AGE_G`) and gender (`SEX1`). Report also on the number of respondents these percentages are based on (exclude any missing values). In the general population, approximately 57.91% of the population never smoked. The following table presents the percentage by age groups and Sex (using relabeled factor variables). 



```{r}
iowa %>%
  filter(SEX1==1 |SEX1==2) %>%
  summarise(Percent_never_smoked=mean(X_SMOKER3_re=="Never Smoked",na.rm = T)*100,N_valid=sum(!is.na(X_SMOKER3_re)))

iowa %>%
  filter(SEX1==1 |SEX1==2) %>%
  group_by(SEX1_label,X_AGE_G_label) %>%
  summarise(Percent_never_smoked=mean(X_SMOKER3_re=="Never Smoked",na.rm = T)*100,N_valid=sum(!is.na(X_SMOKER3_re)))
  
  
```

6. Self-assessed health status is used as an indicator in a lot of health and insurance models. Read up on variable `POORHLTH` in the codebook and recode levels to 'meaningful' numbers (similar to question 3).  What is the relationship between age and the number of poor health days? Is this relationship different for men and women (`SEX1`)? Show plot(s) and describe.


The variable `POORHLTH` record the response for the following question: "During the past 30 days, for about how many days did poor physical or mental health keep you from doing your usual activities, such as self-care, work, or recreation?". 

The following lines recode `POORHLTH` into the number of days sick or NA. 
```{r}
iowa<-iowa %>%
  mutate(POORHLTH_days=ifelse(POORHLTH %in% 1:30,POORHLTH,
                      ifelse(POORHLTH==88,0,NA)))
```


The relationship between poor health days and sex or Age group could be explored using boxplot since Age group and Sex are factor variables and the number of days is a numeric variable, then combining them using the facet option.

```{r}
iowa %>%
  filter(SEX1==1 |SEX1==2) %>%
  ggplot(aes(x=X_AGE_G_label,y=POORHLTH_days))+
  geom_boxplot()+coord_flip()+xlab("Sex")+ylab("Poor healt days")+
  facet_wrap(.~SEX1_label)


iowa %>%
  filter(SEX1==1 |SEX1==2) %>%
  ggplot(aes(x=POORHLTH_days))+
  geom_histogram(scale="free_y",binwidth = 2)+xlab("Sex")+ylab("Count:Poor healt days")+
  facet_grid(X_AGE_G_label~SEX1_label,scale="free_y")

```

If you are interested in the average by Age groups and Sex, another option would be to compute average by those groups and present a tile plot to display the information. 

```{r}

iowa %>%
 filter(SEX1==1 |SEX1==2 ) %>%
  group_by(SEX1_label,X_AGE_G_label)%>%
  summarize(M=mean(POORHLTH_days,na.rm = T))



iowa %>%
 filter(SEX1==1 |SEX1==2 ) %>%
  group_by(SEX1_label,X_AGE_G_label)%>%
  summarize(M=mean(POORHLTH_days,na.rm = T))



iowa %>%
 filter(SEX1==1 |SEX1==2 ) %>%
  group_by(SEX1_label,X_AGE_G_label)%>%
  summarize(M=mean(POORHLTH_days,na.rm = T)) %>%
  ggplot(aes(SEX1_label,X_AGE_G_label,fill=M))+
  geom_tile(colour="white")+
  scale_fill_gradient(low="green", high="red")+xlab("Sex")+ylab("Age group")+ggtitle("Average Poor healt day by Sex and Agre group")


```

In summary, the number of poor health days increase with ages for Males, the worst age group is 55-64 with a higher average.
For females, there seems to be a U-shape relationship, the number of poor health day is greater for the first age group and it decreases until the 45-54 where the number of poor health days increases.
